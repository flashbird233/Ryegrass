{% extends 'base.html' %}
{% load static %}
{% block content %}
    <header>
        <style>
            body {
                height: 100vh;
            {#background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 75%, #000 100%), url("{% static 'images/bg-masthead.jpg' %}");#} background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-color: #2F4F4F;
            }

            #find-me {
                background-image: url("{% static 'images/loc_button.png' %}");
                background-size: cover;
                border: none;
                padding: 0;
                width: 30px;
                height: 30px;
                cursor: pointer;
                color: transparent;
                overflow: hidden;
                background-color: white;
            }
        </style>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>

        <!-- Leaflet-geosearch -->
        <script src="https://unpkg.com/leaflet-geosearch"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css"/>

        <!-- Leaflet Control Geocoder -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

        <!-- Leaflet-semicircle -->
        <script src="https://unpkg.com/leaflet-semicircle"></script>
    </header>

    <!-- Body -->
    <body>
    <!-- Add a title to the map -->
    <h1 style="color: white; text-align: center; margin-top: 6%">Check the Ryegrass Location in VIC</h1>
    <!-- Display the map -->
    <div id="map-container"
         style="display: flex; justify-content: flex-start; height: 80%; width: 85%; margin: auto">

        <!-- Add the map -->
        <div id="map"
             style="height: 100%; width: 80%"></div>

        <!-- Add the sidebar -->
        <div id="sidebar"
             style="height: 100%; width: 20%; float: left; border-left: 1px solid #ccc;
                background-color: #ffffcc;">
            <div id="sidebar-title"
                 style="display: flex; height: 50px;
                         text-align: center; justify-content: center;
                         background-image: url('{% static 'images/MapSiderTitle3.png' %}');
                         background-size: cover">
            </div>

            <!-- Add the input field for the search bar -->
            <input id="start-input" type="text" placeholder="Enter address here..."
                   style="width: 90%; margin: 10px auto">
            <button id="start-search">Search</button>
            <input id="destination-input" type="text" placeholder="Enter destination here..."
                   style="width: 90%; margin: 10px auto">
        </div>
    </div>
    <!-- Add a button to find the user's location -->
    <button id="find-me">Find me</button>
    </body>

    <!-- JavaScript -->
    <script>
        // Add a boundary to the map
        const southWest = L.latLng(-38.433859, 140.961682),
            northEast = L.latLng(-35, 149.976678),
            bounds = L.latLngBounds(southWest, northEast);
        // Create the map
        const map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0,
            maxZoom: 18,
            minZoom: 7
        }).setView([-37.813611, 144.963056], 10);
        // Add the OpenStreetMap tiles
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        // Add markers of ryegrass locations to the map
        fetch('api/locations')
            .then(response => response.json())
            .then(locations => {
                locations.forEach(location => {
                    // Add circles to the map
                    let circle = L.circle([location.rye_lat, location.rye_lon], {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.5,
                        radius: 500
                    }).addTo(map);

                    // Add a popup to the circle
                    circle.bindPopup(`<b>Vernacular Name:</b> ${location.rye_vernacular_name}`);

                    // Add a semi-circle to the map
                    let semiCircle = L.semiCircle([location.rye_lat, location.rye_lon], {
                        radius: 500,
                        startAngle: 0,
                        stopAngle: 180,
                        color: 'blue',
                        fillColor: '#00f',
                        fillOpacity: 0.5
                    }).addTo(map);
                });
            });

        // Add a location search bar on the top of the map
        class LimitedOpenStreetMapProvider extends GeoSearch.OpenStreetMapProvider {
            search({query}) {
                // Call the original search function
                return super.search({query})
                    .then(results => {
                        // Filter the results to only include those within Victoria
                        return results.filter(result => {
                            const {x: lon, y: lat} = result;
                            // These are approximate boundaries for Victoria, adjust as needed
                            const minLat = -39.2246, maxLat = -33.9811, minLon = 140.9617, maxLon = 149.9767;
                            return lat >= minLat && lat <= maxLat && lon >= minLon && lon <= maxLon;
                        });
                    });
            }
        }

        // Create the search control
        const provider = new LimitedOpenStreetMapProvider();
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: provider,
            searchLabel: 'Enter address here...',
            zoomLevel: 10,
            position: 'topright'
        });
        map.addControl(searchControl);

        //Sidebar location search
        // 创建地理编码控件
        var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
        })
            .on('markgeocode', function (e) {
                var bbox = e.geocode.bbox;
                var poly = L.polygon([
                    bbox.getSouthEast(),
                    bbox.getNorthEast(),
                    bbox.getNorthWest(),
                    bbox.getSouthWest()
                ]);
                map.fitBounds(poly.getBounds());
            })
            .addTo(map);

        // 添加一个函数来处理地理编码结果
        function geocodeResult(result) {
            // 从结果中获取纬度和经度
            var lat = result.center.lat;
            var lon = result.center.lng;

            // 创建一个新的标记并添加到地图上
            var marker = L.marker([lat, lon]).addTo(map);

            // 可选：添加一个弹出窗口到标记
            marker.bindPopup("Location found: " + result.name).openPopup();
        }

        // 在侧边栏中添加输入框和按钮
        var addressInput = document.getElementById('start-input');
        var searchButton = document.getElementById('start-search');

        searchButton.addEventListener('click', function () {
            geocoder.geocode(addressInput.value, geocodeResult);
        });

        // Add a button to find the user's location
        const findMeControl = L.control({position: 'topleft'});
        findMeControl.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.appendChild(document.getElementById('find-me'));
            return div;
        };
        findMeControl.addTo(map);
        const findMeButton = document.getElementById('find-me');
        findMeButton.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
            } else {
                navigator.geolocation.getCurrentPosition((position) => {
                    const {latitude, longitude} = position.coords;
                    map.setView([latitude, longitude], 14);
                    L.marker([latitude, longitude]).addTo(map)
                        .bindPopup('You are here')
                        .openPopup();
                }, () => {
                    alert('Unable to retrieve your location');
                });
            }
        });
    </script>
{% endblock %}