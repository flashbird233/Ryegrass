{% extends 'base.html' %}
{% load static %}
{% block content %}
    <header>
        <style>
            body {
                height: 100vh;
                background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 75%, #000 100%), url("{% static 'images/bg-masthead.jpg' %}");
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
            }

            #map {
                height: 75%;
                width: 75%;
                margin-right: auto;
                margin-left: auto
            }

            #find-me {
                background-image: url("{% static 'images/loc_button.png' %}");
                background-size: cover;
                border: none;
                padding: 0;
                width: 30px;
                height: 30px;
                cursor: pointer;
                color: transparent;
                overflow: hidden;
                background-color: white;
            }
        </style>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>

        <!-- Leaflet-geosearch JavaScript -->
        <script src="https://unpkg.com/leaflet-geosearch"></script>
        <!-- Leaflet-geosearch CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch/dist/geosearch.css"/>
    </header>
    <body>
    <h1 style="color: white; text-align: center; margin-top: 7%">Check the Ryegrass Location in VIC</h1>
    <div id="map"></div>
    <button id="find-me">Find me</button>
    </body>
    <script>
        // Add a boundary to the map
        const southWest = L.latLng(-38.433859, 140.961682),
            northEast = L.latLng(-35, 149.976678),
            bounds = L.latLngBounds(southWest, northEast);
        // Create the map
        const map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0,
            maxZoom: 18,
            minZoom: 7
        }).setView([-37.813611, 144.963056], 10);
        // Add the OpenStreetMap tiles
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        // Add markers of ryegrass locations to the map
        fetch('api/locations')
            .then(response => response.json())
            .then(locations => {
                locations.forEach(location => {
                    // Add circles to the map
                    let circle = L.circle([location.rye_lat, location.rye_lon], {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.5,
                        radius: 500
                    }).addTo(map);

                    // Add a popup to the circle
                    circle.bindPopup(`<b>Vernacular Name:</b> ${location.rye_vernacular_name}`);
                });
            });

        // Add a location search bar on the top of the map
        class LimitedOpenStreetMapProvider extends GeoSearch.OpenStreetMapProvider {
            search({query}) {
                // Call the original search function
                return super.search({query})
                    .then(results => {
                        // Filter the results to only include those within Victoria
                        return results.filter(result => {
                            const {x: lon, y: lat} = result;
                            // These are approximate boundaries for Victoria, adjust as needed
                            const minLat = -39.2246, maxLat = -33.9811, minLon = 140.9617, maxLon = 149.9767;
                            return lat >= minLat && lat <= maxLat && lon >= minLon && lon <= maxLon;
                        });
                    });
            }
        }

        const provider = new LimitedOpenStreetMapProvider();
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: provider,
            searchLabel: 'Enter address here...',
            zoomLevel: 10,
            position: 'topright'
        });
        map.addControl(searchControl);

        // Add a button to find the user's location
        const findMeControl = L.control({position: 'topleft'});
        findMeControl.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.appendChild(document.getElementById('find-me'));
            return div;
        };
        findMeControl.addTo(map);
        const findMeButton = document.getElementById('find-me');
        findMeButton.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
            } else {
                navigator.geolocation.getCurrentPosition((position) => {
                    const {latitude, longitude} = position.coords;
                    map.setView([latitude, longitude], 14);
                    L.marker([latitude, longitude]).addTo(map)
                        .bindPopup('You are here')
                        .openPopup();
                }, () => {
                    alert('Unable to retrieve your location');
                });
            }
        });
    </script>
{% endblock %}