{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  html, body {
    height: 100%;
    margin: 0;
    background-color: #2F4F4F;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  section {
    width: 100%;
    max-width: 600px;
    padding: 20px;
    box-sizing: border-box;
  }

  #suggestions, .return-link {
    margin-top: 20px;
  }

  .btn-primary {
    display: inline-block;
    text-decoration: none;
    padding: 10px 20px;
    background-color: #004d00;
    color: white;
    border: none;
    border-radius: 5px;
    margin-top: 20px;
  }

  .image-container {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 300px;
    height: 200px;
  }

  .image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
</style>

<section>
    <p id="weather-info-line" style="display: none;"></p>
    <p>Please enter your outdoor activity time (in hours).</p>
    <label for="duration" class="form-label">Outdoor activity time:</label>
    <select id="duration" class="form-select">
        <option value="0">0 hours</option>
        <option value="1">1 hour</option>
        <option value="2">2 hours</option>
        <option value="3">3 hours</option>
        <option value="4">4 hours</option>
        <option value="5">5 hours</option>
        <option value="more">More than 5 hours</option>
    </select>
    <button onclick="getLocation()" class="btn btn-primary">Get My Location</button>
    <div id="suggestions" style="display">
        <h2>Clothing recommendations:</h2>
        <p id="suggestionsText"></p>
    </div>
{#    <div id="weather-info" style="display">#}
{#        <h2>Weather Information:</h2>#}
{#        <p id="temperature"></p>#}
{#        <p id="humidity"></p>#}
{#        <p id="wind-speed"></p>#}
{#        <p id="wind-direction"></p>#}
{#        <p id="weather-condition"></p>#}
{#    </div>#}
</section>

<section>
    <div class="flex-container">
        <div class="carousel-container">
            <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                <ol class="carousel-indicators">
                    <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                    <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                    <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
                </ol>
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="{% static 'images/1.jpeg' %}" class="d-block w-100" alt="...">
                    </div>
                    <div class="carousel-item">
                        <img src="{% static 'images/2.jpg' %}" class="d-block w-100" alt="...">
                    </div>
                    <div class="carousel-item">
                        <img src="{% static 'images/3.jpg' %}" class="d-block w-100" alt="...">
                    </div>
                </div>
                <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>
    </div>
</section>



<script>
    // 获取相关元素
    var durationSelect = document.getElementById('duration');
    var suggestionsText = document.getElementById('suggestionsText');
    var suggestionsDiv = document.getElementById('suggestions');
    var weatherInfo = document.getElementById('weather-info');
    var temperatureElement = document.getElementById('temperature');
    var humidityElement = document.getElementById('humidity');
    var windSpeedElement = document.getElementById('wind-speed');
    var windDirectionElement = document.getElementById('wind-direction');
    var weatherConditionElement = document.getElementById('weather-condition');
    var weatherInfoLine = document.getElementById('weather-info-line');

    // 处理建议生成
    function generateSuggestions(duration) {
        var suggestions = "";
        if (duration === "0") {
            suggestions = "No protective measures are necessary.";
        } else if (duration === "1") {
            suggestions = "Recommend wearing a surgical mask, sunglasses, long sleeves, trousers, and a hat. Choose tightly woven cotton or synthetic fabrics.";
        } else if (duration === "2" || duration === "3" || duration === "4") {
            suggestions = "Recommend wearing an N95 mask, sunglasses, long sleeves, trousers, gloves, and a hat. Post-exposure, it's advised to wash promptly. Opt for high-performance textiles like microporous materials or specially treated fabrics.";
        } else if (duration === "5" || duration === "more") {
            suggestions = "Advise using an N95 mask, sunglasses, long sleeves, trousers, gloves, and a hat with a substantial brim. After leaving the allergen area, take a shower and change clothes immediately. For clothing material, medical-grade protective garments are preferred.";
        }
        return suggestions;
    }

// 获取天气信息
function getWeatherData(latitude, longitude) {

    console.log('开始获取天气信息:' );

    {#latitude = latitude.toFixed(2);#}
    {#longitude = longitude.toFixed(2);#}
    var latitudeStr = latitude.toString();
    var longitudeStr = longitude.toString();
    {#var key = 'c333242c1b9a686421d34d0c78a4c403';#}
    var key = 'd32542473437f300dfdec104552b7f65';
    var main_url = "https://api.openweathermap.org/data/3.0/onecall?";
    var req_url = main_url + "lat=" + latitude + "&lon=" + longitude + "&appid=" + key;
    console.log('lat= is: ' + latitude);
    console.log('lon= is: ' + longitude);
    console.log('req_url is: ' + req_url);

    fetch(req_url)
        .then(response => response.json())
        .then(data => {
            var temperature = data.current.temp - 273.15; // 转换为摄氏度
            var humidity = data.current.humidity;
            var windSpeed = data.current.wind_speed; // m/s
            var windDeg = data.current.wind_deg; // degrees
            var weatherCondition = data.current.weather[0].main;

            console.log('111111111111111' );

            var weatherInfoText = `Temperature: ${temperature.toFixed(1)}°C, Humidity: ${humidity}%, Wind Speed: ${windSpeed} m/s, Wind Direction: ${windDeg}°, Weather Condition: ${weatherCondition}`;
            weatherInfoLine.textContent = weatherInfoText;
            weatherInfoLine.style.display = 'block'; // 显示 weather-info-line

            temperatureElement.textContent = `Temperature: ${temperature.toFixed(1)}°C`;
            humidityElement.textContent = `Humidity: ${humidity}%`;
            windSpeedElement.textContent = `Wind Speed: ${windSpeed} m/s`;
            windDirectionElement.textContent = `Wind Direction: ${windDeg}°`;
            weatherConditionElement.textContent = `Weather Condition: ${weatherCondition}`;

            weatherInfo.style.display = 'block'; // 显示 weather-info div
        })
        .catch(error => console.error('Error:', error));
}

    // 获取用户位置
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    // 处理获取到的位置信息
    function showPosition(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;

        console.log('开始获取信息' );
        console.log('Latitude: ' + latitude + ', Longitude: ' + longitude);

        console.log('11111' );

        // 获取选择的户外活动时间
        var duration = durationSelect.value;
        console.log('222222222222' );
        // 生成建议
        var suggestions = generateSuggestions(duration);
        suggestionsText.innerText = suggestions;
        suggestionsDiv.style.display = 'block';

        console.log('开始获取天气信息--------------' );

        // 获取天气信息
        getWeatherData(latitude, longitude);

        // 发送 AJAX 请求到 get_data 视图函数
        fetch('/get_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ latitude: latitude, longitude: longitude })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Data:', data);
            // 在这里更新前端的显示,依据实际返回的数据结构
        })
        .catch(error => console.error('Error:', error));
    }

    // 监听户外活动时间选择变化
    durationSelect.addEventListener('change', function() {
        var duration = this.value;
        var suggestions = generateSuggestions(duration);
        suggestionsText.innerText = suggestions;
        suggestionsDiv.style.display = 'block';
    });

    // 初始化走马灯轮播图
    $('.carousel').carousel({
        interval: 5000 // 自动轮播间隔时间（以毫秒为单位）
    });
</script>

<!-- Bootstrap 和相关的 JavaScript 库 -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% endblock %}